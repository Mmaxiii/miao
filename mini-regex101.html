<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini Regex101</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      display: flex;
      flex-flow: column;
    }

    header {

      height: 45px;
      background-color: #2C5C97;

      flex-shrink: 0;
    }

    .content {
      display: flex;
      flex-grow: 1;
    }

    xnav {
      width: 100px;
      background-color: #acf;
    }

    aside {
      width: 350px;
      background-color: #FDFDFD;
    }

    main {
      flex-grow: 1;
      padding: 0 10px;
      background-color: #E5E5E5;
    }

    .head {
      position: relative;
    }

    #reInput {
      width: 100%;
      box-sizing: border-box;
    }

    .box {
      position: relative;
      height: 250px;
    }

    #testStringInput,
    #resultShow {
      position: absolute;
      top: 0;
      box-sizing: border-box;
      overflow: auto;
      width: 100%;
      height: 250px;
      border: 1px solid;
      padding: 0;
      margin: 0;
      line-height: 1.3em;
      font-size: 20px;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      resize: none;
      background-color: initial;
    }


    strong {
      font-weight: normal;
    }

    strong:nth-child(odd),
    .mInfo:nth-child(odd) ::after {
      background-color: #D5EBFF;
    }

    strong:nth-child(even),
    .mInfo:nth-child(even) ::after {
      background-color: #9FCFFF;
    }

    /* 有元组存在，strong不是空，无法高亮 */
    strong:empty,
    strong em:empty {
      display: inline-block;
      width: 2px;
      height: 20px;
      margin: 0 -1px;
      line-height: 1.3em;
      vertical-align: bottom;
      background-color: red;
    }

    em {
      font-style: normal;
    }

    em:nth-child(1),
    .mRow:nth-child(2) ::after {
      background-color: #1abc9c;
    }

    em:nth-child(2),
    .mRow:nth-child(3) ::after {
      background-color: #f1c40f;
    }

    em:nth-child(3),
    .mRow:nth-child(4) ::after {
      background-color: #27ae60;
    }

    em:nth-child(4),
    .mRow:nth-child(5) ::after {
      background-color: #95a5a6;
    }

    em:nth-child(5),
    .mRow:nth-child(6) ::after {
      background-color: #ecf0f1;
    }

    #spendTime {
      position: absolute;
      top: 0;
      right: 0;
      padding: 3px 10px;
      margin-top: 5px;
      font-size: 12px;
      border-radius: 2px;
      color: #fff;
      background-color: #16a085;
    }

    #matchInfo {
      font-size: 12px;

    }



    .mInfo {
      margin: 10px;
    }

    .mRow {
      margin: 5px;
    }

    .mRow span:first-child {
      position: relative;
      display: inline-block;
      margin-right: 10px;
      /* width: 65px; */
    }

    .mRow span:nth-child(2) {

      display: inline-block;
      width: 50px;
    }

    .mRow span:first-child::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 100%;
      height: 4px;
      /* background-color: red; */
    }
  </style>
</head>

<body>
  <header></header>
  <div class="content">
    <nav></nav>
    <main>
      <div class="head">
        <div>REGULAR RXPRESSION</div>
        <div id="spendTime">ss</div>
        <input type="text" id="reInput" oninput="run()" value="|()">
        <div>
          <label>g<input type="checkbox" checked id="reFlagG"></label>
          <label>m<input type="checkbox" id="reFlagM"></label>
          <label>i<input type="checkbox" id="reFlagI"></label>
        </div>

      </div>
      <div class="text">
        <div>TEST STRING</div>
        <div class="box">
          <textarea id="testStringInput" cols="30" rows="10" oninput="run()">asdfasdfasdfasdf</textarea>
          <pre id="resultShow" contenteditable oninput="run()" value='aaa'></pre>
        </div>
        <div>SUBSTITUTION</div>
        <input type="text" id="inputSub" oninput="replace()">
        <div id="showSub"></div>
      </div>
    </main>
    <aside>
      <div>MATCH INFORMATION</div>
      <div id="matchInfo"></div>
    </aside>
  </div>
</body>

</html>
<script>
  'use strict'
  function run() {
    let startTime = new Date()
    let flags = getFlags()
    let startIdx = 0
    let testStr = testStringInput.value
    let re
    if (reInput.value == '') {
      resultShow.innerHTML = testStr + '\n'
      return
    }
    try {
      re = new RegExp(reInput.value, flags + 'd')
    } catch (e) {
      if (e instanceof SyntaxError) {
        resultShow.innerHTML = testStr + '\n'
        return
      } else {
        throw e
      }
    }
    let resHTML = ''
    let match
    let matchCount = 0
    let info = ''

    while (match = re.exec(testStr)) {
      matchCount++
      resHTML += testStr.slice(startIdx, match.index)
      resHTML += `<strong title='Match ${matchCount}'>${heightLineGroups(match, matchCount)}</strong>`
      info += `<div class="mInfo">${modifyInfo(match, matchCount)}</div>`
      startIdx = re.lastIndex

      if (match[0] == '') {
        re.lastIndex++
      }
      if (!re.global) {
        startIdx = match.index + match[0].length
        break
      }
    }
    resHTML += testStr.slice(startIdx)
    resultShow.innerHTML = resHTML + '\n'
    let endTime = new Date()
    inputTime(endTime - startTime, matchCount)
    replace()
    matchInfo.innerHTML = info
  }

  function heightLineGroups(match, matchCount) {

    if (match.length == 1) {
      return match[0]
    }
    let startIdx = 0
    let matchRanges = match.indices.map(it => {
      if (it) {
        let start = it[0] - match.index
        let end = it[1] - match.index
        return [start, end]
      }
    })
    //找到 em 标签位置
    let matchStr = match[0]
    let labels = Array(matchStr.length + 1).fill('')
    for (let i = 1; i < match.length; i++) {
      let range = matchRanges[i]
      if (range) {
        labels[range[0]] += `<em title='Match ${matchCount}\nGroup:${i}\nPos${range[0], range[1]}'>`
        labels[range[1]] += '</em>'
      }
    }

    //拼接 em 标签及其内容
    let res = ''
    for (let i = 0; i < matchStr.length; i++) {
      res += labels[i]
      res += matchStr[i]
    }
    res += labels[labels.length - 1]
    console.log(res)
    return res
  }

  function inputTime(time, matchCount) {
    spendTime.innerHTML = `${matchCount} match (${time})ms`
  }

  function replace() {
    let flags = getFlags()
    let testStr = testStringInput.value
    let re
    try {
      re = new RegExp(reInput.value, flags + 'd')
    } catch (e) {
      if (e instanceof SyntaxError) {
        resultShow.innerHTML = testStr + '\n'
        return
      } else {
        throw e
      }
    }
    let replacement = inputSub.value
    showSub.innerText = testStr.replace(re, replacement)

  }
  function modifyInfo(match, matchCount) {
    let resHTML = ''
    for (let i = 0; i < match.length; i++) {
      if (match[i]) {

        let header = `Match ${matchCount}`
        if (i > 0) {
          header = `Group ${i}`
        }
        resHTML += `<div class="mRow"><span>${header}</span><span>${match.indices[i][0]}-${match.indices[i][1]}</span><span>${match[i]}</span></div>`

      }
    }
    return resHTML
  }
  function getFlags() {
    let res = ''
    if (reFlagG.checked) {
      res += 'g'
    }
    if (reFlagM.checked) {
      res += 'm'
    }
    if (reFlagI.checked) {
      res += 'i'
    }
    return res
  }
  run()
</script>